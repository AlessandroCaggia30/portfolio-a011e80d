```markdown
---
title: "Code TS2"
author: Stefano De Bianchi, Alessandro Caggia, Emanuele Cinti, Edoardo Calleri di
  Sala
date: "Second Assignment"
output: html_document
---
```{r}
```{r setup, message=FALSE, warning=FALSE}
library(depmixS4)
library(ggplot2)
library(dplyr)
library(patchwork)
library(ggthemes)

setwd("/Users/Alessandro/Desktop")

# Load data
data <- read.csv("/Users/Alessandro/Desktop/data_assHMM.csv")
data$real_interest <- data$ITAbond_nom - data$inflation
data$Date <- as.Date(data$Time, format = "%Y_%m_%d")

# Homogeneous HMM
set.seed(123)
hmm_model <- depmix(real_interest ~ 1, data = data, nstates = 3,
                    family = gaussian(), ntimes = nrow(data))
hmm_fit <- fit(hmm_model, verbose = TRUE)
hmm_post <- posterior(hmm_fit)

data$hmm_state <- factor(hmm_post$state, levels = 1:3,
                         labels = c("Recession", "Stable", "Boom"))
data$prob1 <- hmm_post$S1  # Boom
data$prob2 <- hmm_post$S2  # Stable
data$prob3 <- hmm_post$S3  # Recession

hmm_means <- sapply(hmm_fit@response, function(r) r[[1]]@parameters$coefficients)
data$hmm_implied <- sapply(hmm_post$state, function(s) hmm_means[s])

# Set theme
theme_clean_base <- theme_minimal(base_size = 12) + 
  theme(
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA)
  )

theme_custom <- theme_clean_base + theme(
  panel.grid = element_blank(),
  panel.grid.major.y = element_line(colour = "#e3e1e1", linetype = 2),
  plot.title.position = 'plot',
  legend.position = 'top',
  legend.title = element_blank()
)

theme_set(theme_custom)

# Plot 0: Homogeneous HMM States
p1 <- ggplot(data, aes(x = Date)) +
  geom_line(aes(y = real_interest), color = "darkblue", linewidth = 0.7) +
  geom_point(aes(y = real_interest, color = hmm_state), size = 1.3) +
  scale_color_manual(values = c("Boom" = "green", "Stable" = "blue", "Recession" = "red")) +
  labs(title = "Panel (a): Real Interest Rate and HMM States (Homogeneous)",
       x = "", y = "Real Interest Rate", color = "State") +
  theme_custom

# Plot 1: State probabilities
p2 <- ggplot(data, aes(x = Date)) +
  geom_line(aes(y = prob1), color = "red", linetype = "solid", linewidth = 0.5) +
  geom_line(aes(y = prob2), color = "blue", linetype = "solid", linewidth = 0.5) +
  geom_line(aes(y = prob3), color = "green", linetype = "solid", linewidth = 0.5) +
  labs(title = "Panel (b): HMM derived state probabilities", x = "Date", y = "Probability") +
  theme_custom

# Combine vertically
combined_plot <- p1 / p2
plot(combined_plot)
ggsave("combined_plot.png", plot = combined_plot, width = 10, height = 8)

# Plot 2: Real vs Implied (Homogeneous)
p3 <- ggplot(data, aes(x = Date)) +
  geom_line(aes(y = real_interest), color = "darkblue", linewidth = 0.7, alpha = 0.7) +
  geom_line(aes(y = hmm_implied), color = "red", linetype = "dashed", linewidth = 0.8) +
  labs(title = "Real vs Implied Interest Rate (Homogeneous HMM)",
       x = "Date", y = "Interest Rate") +
  theme_custom
plot(p3)
ggsave("hmm_implied_plot.png", plot = p3, width = 10, height = 5)

# Provide MLE
summary(hmm_fit)

# ---------------------------------------
# Non-homogeneous HMM
# ---------------------------------------
set.seed(123)
nh_model <- depmix(response = real_interest ~ 1,
                   transition = ~ inflation + gdp,
                   data = data,
                   nstates = 3,
                   family = gaussian(),
                   ntimes = nrow(data))
nh_fit <- fit(nh_model, verbose = TRUE)
nh_post <- posterior(nh_fit)

data$nh_state <- factor(nh_post$state, levels = 1:3,
                        labels = c("Recession", "Stable", "Boom"))

nh_means <- sapply(nh_fit@response, function(r) r[[1]]@parameters$coefficients)
data$nh_implied <- sapply(nh_post$state, function(s) nh_means[s])

# Plot 3: NH-HMM States
p4 <- ggplot(data, aes(x = Date)) +
  geom_line(aes(y = real_interest), color = "darkblue", linewidth = 0.7) +
  geom_point(aes(y = real_interest, color = nh_state), size = 1.3) +
  scale_color_manual(values = c("Boom" = "green", "Stable" = "blue", "Recession" = "red")) +
  labs(title = "Real Interest Rate and NH-HMM States",
       x = "Date", y = "Real Interest Rate", color = "State") +
  theme_custom
ggsave("nh_hmm_states_plot.png", plot = p4, width = 10, height = 5)
plot(p4)

# Plot 4: Real vs Implied (Non-Homogeneous)
p5 <- ggplot(data, aes(x = Date)) +
  geom_line(aes(y = real_interest), color = "darkblue", linewidth = 0.7, alpha = 0.7) +
  geom_line(aes(y = nh_implied), color = "red", linetype = "dashed", linewidth = 0.8) +
  labs(title = "Real vs Implied Interest Rate (NH-HMM)",
       x = "Date", y = "Interest Rate") +
  theme_custom
ggsave("nh_hmm_implied_plot.png", plot = p5, width = 10, height = 5)
plot(p5)